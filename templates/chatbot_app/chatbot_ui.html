{% load static %}
<style>
  /* Sticky Button */
  .chatbot-button {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 60px;
    height: 60px;
    background-color: #007bff; /* Primary blue */
    color: white;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 1.5rem;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    cursor: pointer;
    z-index: 1000; /* Ensure it's on top */
  }

  /* Chat UI Container */
  .chatbot-container {
    position: fixed;
    bottom: 100px; /* 버튼 위쪽에 위치 */
    right: 30px;
    width: 380px; /* 적당한 챗봇 창 너비 */
    height: 500px; /* 적당한 챗봇 창 높이 */
    background-color: #f8f9fa; /* Light background */
    border: 1px solid #dee2e6;
    border-radius: 10px;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    z-index: 999;
    transform: translateY(100%); /* Initially hidden below screen */
    opacity: 0;
    transition: transform 0.3s ease-out, opacity 0.3s ease-out; /* Animation */
  }

  .chatbot-container.active {
    transform: translateY(0); /* Slide up */
    opacity: 1;
  }

  .chatbot-header {
    background-color: #007bff;
    color: white;
    padding: 15px;
    border-top-left-radius: 9px;
    border-top-right-radius: 9px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
  }

  .chatbot-header .close-btn {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0 5px;
  }

  .chatbot-body {
    flex-grow: 1;
    padding: 15px;
    overflow-y: auto; /* Scrollable chat area */
    background-color: white;
  }

  .chatbot-footer {
    padding: 15px;
    background-color: #e9ecef;
    border-bottom-left-radius: 9px;
    border-bottom-right-radius: 9px;
    display: flex;
  }

  /* 챗 메시지 스타일 */
  .chat-message {
    padding: 8px 12px;
    border-radius: 15px;
    margin-bottom: 10px;
    max-width: 80%;
    word-wrap: break-word;
  }

  .chat-message.bot {
    background-color: #e2e6ea; /* Light gray for bot messages */
    align-self: flex-start;
    border-bottom-left-radius: 2px;
  }

  .chat-message.user {
    background-color: #007bff; /* Blue for user messages */
    color: white;
    align-self: flex-end;
    border-bottom-right-radius: 2px;
  }

  /* 서비스 선택 버튼 컨테이너 */
  .service-options {
    display: flex;
    flex-direction: column;
    gap: 8px; /* 버튼 사이 간격 */
    margin-top: 10px;
  }

  .service-options .btn {
    width: 100%; /* 버튼 너비를 100%로 설정 */
    text-align: center;
    white-space: normal; /* 텍스트가 길 경우 줄 바꿈 */
  }

  /* 챗봇 바디 스크롤 및 메시지 정렬 */
  .chatbot-body {
    flex-grow: 1;
    padding: 15px;
    overflow-y: auto;
    background-color: white;
    display: flex; /* Flexbox 사용하여 메시지 정렬 */
    flex-direction: column; /* 세로 방향으로 정렬 */
  }
</style>

<div class="chatbot-button" id="chatbotToggleBtn">💬</div>

<div class="chatbot-container" id="chatbotContainer">
  <div class="chatbot-header">
    <span>수파자 AI 상담</span>
    <button class="close-btn" id="chatbotCloseBtn">&times;</button>
  </div>
  <div class="chatbot-body" id="chatbotBody">
    <div class="chat-message bot">
      안녕하세요! 수파자 AI 상담 챗봇입니다. 무엇을 도와드릴까요?
    </div>
    <div class="chat-message bot">문의하실 서비스를 선택해주세요:</div>
    <div class="service-options" id="serviceOptions">
      <button
        class="btn btn-outline-primary service-select-btn"
        data-service="수파자 과외"
      >
        수파자 과외
      </button>
      <button
        class="btn btn-outline-primary service-select-btn"
        data-service="수파자 낭독"
      >
        수파자 낭독
      </button>
      <button
        class="btn btn-outline-primary service-select-btn"
        data-service="소방 히어로 멤버십"
      >
        소방 히어로 멤버십
      </button>
      <button
        class="btn btn-outline-primary service-select-btn"
        data-service="기타 문의"
      >
        기타 문의
      </button>
    </div>
  </div>
  <div class="chatbot-footer">
    <div style="flex-grow: 1">
      <input
        type="text"
        class="form-control"
        id="chatInput"
        placeholder="문의 사항을 입력하세요..."
        disabled
      />
    </div>
    <div style="margin-left: 10px">
      <button
        type="submit"
        class="btn btn-primary"
        id="sendMessageBtn"
        disabled
      >
        전송
      </button>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const toggleBtn = document.getElementById("chatbotToggleBtn");
    const closeBtn = document.getElementById("chatbotCloseBtn");
    const chatbotContainer = document.getElementById("chatbotContainer");
    const chatbotBody = document.getElementById("chatbotBody");
    const serviceOptions = document.getElementById("serviceOptions");
    const chatInput = document.getElementById("chatInput");
    const sendMessageBtn = document.getElementById("sendMessageBtn");

    let selectedService = null; // 선택된 서비스를 저장할 변수

    // 챗봇 버튼 클릭 시 챗 UI 토글
    toggleBtn.addEventListener("click", function () {
      chatbotContainer.classList.toggle("active");
      if (chatbotContainer.classList.contains("active")) {
        chatbotBody.scrollTop = chatbotBody.scrollHeight; // 챗봇 열릴 때 스크롤 최하단으로
      }
    });

    // 챗봇 닫기 버튼 클릭 시 챗 UI 숨기기
    closeBtn.addEventListener("click", function () {
      chatbotContainer.classList.remove("active");
      // 닫을 때 상태 초기화 (옵션)
      resetChatbotState();
    });

    // 서비스 선택 버튼 클릭 이벤트
    serviceOptions.addEventListener("click", function (event) {
      if (event.target.classList.contains("service-select-btn")) {
        selectedService = event.target.dataset.service;
        displayMessage(`"${selectedService}"를 선택하셨습니다.`, "user"); // 사용자가 선택한 것처럼 표시
        displayMessage(
          `${selectedService}에 대해 문의 사항을 입력해주세요.`,
          "bot"
        );

        // 서비스 선택 버튼 숨기고 입력창 활성화
        serviceOptions.style.display = "none";
        chatInput.removeAttribute("disabled");
        sendMessageBtn.removeAttribute("disabled");
        chatInput.focus(); // 입력창에 포커스

        // (나중에) 선택된 서비스에 따라 백엔드로 데이터를 전송하는 로직 추가
      }
    });

    // 메시지 전송 (현재는 UI 테스트용)
    sendMessageBtn.addEventListener("click", function () {
      sendMessage();
    });

    chatInput.addEventListener("keypress", function (event) {
      if (event.key === "Enter") {
        sendMessage();
      }
    });

    function sendMessage() {
      const messageText = chatInput.value.trim();
      if (messageText) {
        displayMessage(messageText, "user");
        chatInput.value = ""; // 입력 필드 초기화
        // (나중에) 이 메시지를 백엔드로 전송하는 로직 추가
        // 현재는 AI 답변 로직이 없으므로, 간단한 응답 표시
        displayMessage(
          "죄송합니다. 아직 답변 기능을 개발 중입니다. (테스트 메시지)",
          "bot"
        );
      }
    }

    // 메시지를 챗봇 창에 표시하는 함수
    function displayMessage(text, sender) {
      const messageDiv = document.createElement("div");
      messageDiv.classList.add("chat-message", sender);
      messageDiv.textContent = text;
      chatbotBody.appendChild(messageDiv);
      chatbotBody.scrollTop = chatbotBody.scrollHeight; // 스크롤을 최하단으로 이동
    }

    // 챗봇 상태 초기화 함수 (닫을 때 또는 새로 시작할 때)
    function resetChatbotState() {
      selectedService = null;
      chatbotBody.innerHTML = `
                <div class="chat-message bot">안녕하세요! 수파자 AI 상담 챗봇입니다. 무엇을 도와드릴까요?</div>
                <div class="chat-message bot">문의하실 서비스를 선택해주세요:</div>
                <div class="service-options" id="serviceOptions">
                    <button class="btn btn-outline-primary service-select-btn" data-service="수파자 과외">수파자 과외</button>
                    <button class="btn btn-outline-primary service-select-btn" data-service="수파자 낭독">수파자 낭독</button>
                    <button class="btn btn-outline-primary service-select-btn" data-service="소방 히어로 멤버십">소방 히어로 멤버십</button>
                    <button class="btn btn-outline-primary service-select-btn" data-service="기타 문의">기타 문의</button>
                </div>
            `;
      chatInput.setAttribute("disabled", "true");
      sendMessageBtn.setAttribute("disabled", "true");

      // 서비스 선택 버튼 컨테이너를 다시 활성화 (새로 생성했으므로 다시 DOM에서 찾아야 함)
      const newServiceOptions = chatbotBody.querySelector(".service-options");
      if (newServiceOptions) {
        newServiceOptions.style.display = "flex"; // flex로 설정하여 버튼이 보이게 함
        // resetChatbotState가 호출된 후 새로 생성된 버튼에 이벤트 리스너를 다시 연결해야 하지만,
        // 현재는 DOMContentLoaded에서 한 번만 붙이므로, 실제 로직에서는 동적 요소에 대한 이벤트 위임을 고려해야 합니다.
        // 여기서는 간단한 UI 테스트이므로, 새롭게 생성된 serviceOptions에 대한 이벤트는 다시 붙이지 않습니다.
        // 실제 개발 시에는 이벤트 위임을 사용하거나, resetChatbotState가 DOM 구조를 다시 그리지 않고 내용을 업데이트하는 방식으로 변경해야 합니다.
      }
      // 현재 코드에서는 resetChatbotState가 호출될 때 serviceOptions가 새로 생성되므로
      // serviceOptions에 대한 이벤트 리스너는 resetChatbotState 외부에서 (DOMContentLoaded처럼) 한 번만 붙여서는 안됩니다.
      // 임시로, resetChatbotState에서 이벤트 리스너를 다시 붙이는 코드를 포함합니다. (실제 프로젝트에서는 이벤트 위임 권장)
      attachServiceOptionListeners();
    }

    // 서비스 선택 버튼에 이벤트 리스너를 다시 붙이는 함수
    function attachServiceOptionListeners() {
      const currentServiceOptionsContainer =
        chatbotBody.querySelector("#serviceOptions");
      if (currentServiceOptionsContainer) {
        currentServiceOptionsContainer.addEventListener(
          "click",
          function (event) {
            if (event.target.classList.contains("service-select-btn")) {
              selectedService = event.target.dataset.service;
              displayMessage(`"${selectedService}"를 선택하셨습니다.`, "user");
              displayMessage(
                `${selectedService}에 대해 문의 사항을 입력해주세요.`,
                "bot"
              );

              currentServiceOptionsContainer.style.display = "none";
              chatInput.removeAttribute("disabled");
              sendMessageBtn.removeAttribute("disabled");
              chatInput.focus();
            }
          }
        );
      }
    }
    // 초기 로드 시 서비스 옵션 리스너 붙이기
    attachServiceOptionListeners();
  });
</script>
