{% load static %}
<style>
  /* Sticky Button */
  .chatbot-button {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 60px;
    height: 60px;
    background-color: #007bff; /* Primary blue */
    color: white;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 1.5rem;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    cursor: pointer;
    z-index: 1000; /* Ensure it's on top */
  }

  /* Chat UI Container */
  .chatbot-container {
    position: fixed;
    bottom: 100px; /* ë²„íŠ¼ ìœ„ìª½ì— ìœ„ì¹˜ */
    right: 30px;
    width: 380px; /* ì ë‹¹í•œ ì±—ë´‡ ì°½ ë„ˆë¹„ */
    height: 500px; /* ì ë‹¹í•œ ì±—ë´‡ ì°½ ë†’ì´ */
    background-color: #f8f9fa; /* Light background */
    border: 1px solid #dee2e6;
    border-radius: 10px;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    z-index: 999;
    transform: translateY(100%); /* Initially hidden below screen */
    opacity: 0;
    transition: transform 0.3s ease-out, opacity 0.3s ease-out; /* Animation */
  }

  .chatbot-container.active {
    transform: translateY(0); /* Slide up */
    opacity: 1;
  }

  .chatbot-header {
    background-color: #007bff;
    color: white;
    padding: 15px;
    border-top-left-radius: 9px;
    border-top-right-radius: 9px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
  }

  .chatbot-header .close-btn {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0 5px;
  }

  .chatbot-body {
    flex-grow: 1;
    padding: 15px;
    overflow-y: auto; /* Scrollable chat area */
    background-color: white;
  }

  .chatbot-footer {
    padding: 15px;
    background-color: #e9ecef;
    border-bottom-left-radius: 9px;
    border-bottom-right-radius: 9px;
    display: flex;
  }

  /* ì±— ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
  .chat-message {
    padding: 8px 12px;
    border-radius: 15px;
    margin-bottom: 10px;
    max-width: 80%;
    word-wrap: break-word;
  }

  .chat-message.bot {
    background-color: #e2e6ea; /* Light gray for bot messages */
    align-self: flex-start;
    border-bottom-left-radius: 2px;
  }

  .chat-message.user {
    background-color: #007bff; /* Blue for user messages */
    color: white;
    align-self: flex-end;
    border-bottom-right-radius: 2px;
  }

  /* ì„œë¹„ìŠ¤ ì„ íƒ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ */
  .service-options {
    display: flex;
    flex-direction: column;
    gap: 8px; /* ë²„íŠ¼ ì‚¬ì´ ê°„ê²© */
    margin-top: 10px;
  }

  .service-options .btn {
    width: 100%; /* ë²„íŠ¼ ë„ˆë¹„ë¥¼ 100%ë¡œ ì„¤ì • */
    text-align: center;
    white-space: normal; /* í…ìŠ¤íŠ¸ê°€ ê¸¸ ê²½ìš° ì¤„ ë°”ê¿ˆ */
  }

  /* ì±—ë´‡ ë°”ë”” ìŠ¤í¬ë¡¤ ë° ë©”ì‹œì§€ ì •ë ¬ */
  .chatbot-body {
    flex-grow: 1;
    padding: 15px;
    overflow-y: auto;
    background-color: white;
    display: flex; /* Flexbox ì‚¬ìš©í•˜ì—¬ ë©”ì‹œì§€ ì •ë ¬ */
    flex-direction: column; /* ì„¸ë¡œ ë°©í–¥ìœ¼ë¡œ ì •ë ¬ */
  }
</style>

<div class="chatbot-button" id="chatbotToggleBtn">ğŸ’¬</div>

<div class="chatbot-container" id="chatbotContainer">
  <div class="chatbot-header">
    <span>ìˆ˜íŒŒì AI ìƒë‹´</span>
    <button class="close-btn" id="chatbotCloseBtn">&times;</button>
  </div>
  <div class="chatbot-body" id="chatbotBody"></div>
  <div class="chatbot-footer">
    <div style="flex-grow: 1">
      <input
        type="text"
        class="form-control"
        id="chatInput"
        placeholder="ë¬¸ì˜ ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”..."
        disabled
      />
    </div>
    <div style="margin-left: 10px">
      <button
        type="submit"
        class="btn btn-primary"
        id="sendMessageBtn"
        disabled
      >
        ì „ì†¡
      </button>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const toggleBtn = document.getElementById("chatbotToggleBtn");
    const closeBtn = document.getElementById("chatbotCloseBtn");
    const chatbotContainer = document.getElementById("chatbotContainer");
    const chatbotBody = document.getElementById("chatbotBody");
    const chatInput = document.getElementById("chatInput");
    const sendMessageBtn = document.getElementById("sendMessageBtn");

    let selectedService = null;
    const chatApiUrl = "{% url 'chatbot_app:chat_api' %}";

    let currentBotMessageDiv = null; // í˜„ì¬ ë´‡ ë©”ì‹œì§€ê°€ ì¶”ê°€ë  div

    // ì±—ë´‡ ì´ˆê¸° ìƒíƒœ ì„¤ì •
    function initializeChatbot() {
      chatbotBody.innerHTML = `
                <div class="chat-message bot">ì•ˆë…•í•˜ì„¸ìš”! ìˆ˜íŒŒì AI ìƒë‹´ ì±—ë´‡ì…ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?</div>
                <div class="chat-message bot">ë¬¸ì˜í•˜ì‹¤ ì„œë¹„ìŠ¤ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”:</div>
                <div class="service-options" id="serviceOptions">
                    <button class="btn btn-outline-primary service-select-btn" data-service="ê³¼ì™¸">ìˆ˜íŒŒì ê³¼ì™¸</button>
                    <button class="btn btn-outline-primary service-select-btn" data-service="ë‚­ë…">ìˆ˜íŒŒì ë‚­ë…</button>
                    <button class="btn btn-outline-primary service-select-btn" data-service="ì†Œë°©">ì†Œë°© íˆì–´ë¡œ ë©¤ë²„ì‹­</button>
                </div>
            `;
      attachServiceOptionListeners();
      chatInput.setAttribute("disabled", "true");
      sendMessageBtn.setAttribute("disabled", "true");
      selectedService = null;
      chatbotBody.scrollTop = chatbotBody.scrollHeight;
      currentBotMessageDiv = null; // ì´ˆê¸°í™” ì‹œ í˜„ì¬ ë´‡ ë©”ì‹œì§€ divë„ ì´ˆê¸°í™”
    }

    function attachServiceOptionListeners() {
      const currentServiceOptionsContainer =
        chatbotBody.querySelector("#serviceOptions");
      if (currentServiceOptionsContainer) {
        currentServiceOptionsContainer.addEventListener(
          "click",
          function (event) {
            if (event.target.classList.contains("service-select-btn")) {
              selectedService = event.target.dataset.service;
              const displayServiceName = event.target.textContent;
              displayMessage(
                `"${displayServiceName}"ë¥¼ ì„ íƒí•˜ì…¨ìŠµë‹ˆë‹¤.`,
                "user"
              );
              displayMessage(
                `${displayServiceName}ì— ëŒ€í•´ ë¬¸ì˜ ì‚¬í•­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.`,
                "bot"
              );

              currentServiceOptionsContainer.style.display = "none";
              chatInput.removeAttribute("disabled");
              sendMessageBtn.removeAttribute("disabled");
              chatInput.focus();
            }
          }
        );
      }
    }

    function displayMessage(text, sender) {
      const messageDiv = document.createElement("div");
      messageDiv.classList.add("chat-message", sender);
      messageDiv.innerHTML = text; // HTMLì„ í—ˆìš©í•  ìˆ˜ ìˆë„ë¡ textContent ëŒ€ì‹  innerHTML ì‚¬ìš© (ë¡œë”© ìŠ¤í”¼ë„ˆ ë“±ì„ ìœ„í•´)
      chatbotBody.appendChild(messageDiv);
      chatbotBody.scrollTop = chatbotBody.scrollHeight;
      return messageDiv; // ìƒì„±ëœ ë©”ì‹œì§€ div ë°˜í™˜ (ìŠ¤íŠ¸ë¦¬ë° ì‹œ ì‚¬ìš©)
    }

    // ì±—ë´‡ API í˜¸ì¶œ í•¨ìˆ˜ (SSE ìŠ¤íŠ¸ë¦¬ë°)
    async function fetchChatResponseStream(question, category) {
      // "ë‹µë³€ ìƒì„± ì¤‘..." ë©”ì‹œì§€ë¥¼ ë¨¼ì € í‘œì‹œ (ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘ ì „)
      currentBotMessageDiv = displayMessage(
        `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ë‹µë³€ ìƒì„± ì¤‘...`,
        "bot"
      );
      let receivedFullResponse = ""; // ìŠ¤íŠ¸ë¦¬ë°ìœ¼ë¡œ ë°›ì€ ì „ì²´ ì‘ë‹µì„ ì €ì¥í•  ë³€ìˆ˜

      try {
        // EventSourceëŠ” GET ìš”ì²­ë§Œ ì§€ì›í•˜ë¯€ë¡œ, POST ìš”ì²­ì„ ìœ„í•´ì„œëŠ” fetchë¥¼ ì‚¬ìš©í•˜ê³ 
        // response.body.getReader()ë¥¼ í†µí•´ ReadableStreamì„ ì²˜ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤.
        // ë˜ëŠ”, ë°±ì—”ë“œì—ì„œ POST ìš”ì²­ì„ ë°›ì€ í›„ ë³„ë„ì˜ SSE ì—”ë“œí¬ì¸íŠ¸ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸í•˜ëŠ” ë°©ì‹ì„ ì‚¬ìš©í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

        // ì—¬ê¸°ì„œëŠ” Django chat_apiê°€ POSTë¥¼ ë°›ê³  StreamingHttpResponseë¡œ SSEë¥¼ ë³´ë‚´ë¯€ë¡œ
        // fetch APIë¥¼ ì‚¬ìš©í•˜ê³  ReadableStreamReaderë¥¼ ì§ì ‘ ì½ì–´ ì²˜ë¦¬í•©ë‹ˆë‹¤.
        const response = await fetch(chatApiUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ question: question, category: category }),
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(
            `HTTP ì˜¤ë¥˜: ${response.status} - ${
              errorData.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"
            }`
          );
        }

        // ìŠ¤íŠ¸ë¦¼ ë¦¬ë”ë¥¼ ê°€ì ¸ì˜´
        const reader = response.body.getReader();
        const decoder = new TextDecoder("utf-8");

        let buffer = "";
        const SSE_DELIMITER = "\nSSE_DELIMITER\n";

        // ë¡œë”© ë©”ì‹œì§€ ì œê±°í•˜ê³  ì‹¤ì œ ë‹µë³€ì„ ë°›ì„ div ì¤€ë¹„
        if (currentBotMessageDiv) {
          currentBotMessageDiv.innerHTML = ""; // ê¸°ì¡´ ë¡œë”© ë©”ì‹œì§€ ì´ˆê¸°í™”
        } else {
          currentBotMessageDiv = displayMessage("", "bot"); // divê°€ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
        }

        // ìŠ¤íŠ¸ë¦¼ì—ì„œ ë°ì´í„° ì½ê¸°
        while (true) {
          const { value, done } = await reader.read();
          if (done) break;

          buffer += decoder.decode(value, { stream: true }); // ìŠ¤íŠ¸ë¦¼ ë””ì½”ë”©

          let delimiterIndex = buffer.indexOf(SSE_DELIMITER);
          while (delimiterIndex !== -1) {
            const eventString = buffer.substring(0, delimiterIndex);
            buffer = buffer.substring(delimiterIndex + SSE_DELIMITER.length); // ì²˜ë¦¬ëœ ë¶€ë¶„ ì œê±°

            if (eventString.startsWith("data: ")) {
              const jsonStr = eventString.substring(6);
              try {
                const content = JSON.parse(jsonStr);
                receivedFullResponse += content;
                if (currentBotMessageDiv) {
                  currentBotMessageDiv.innerHTML = receivedFullResponse.replace(
                    /\n/g,
                    "<br>"
                  );
                  chatbotBody.scrollTop = chatbotBody.scrollHeight;
                }
              } catch (e) {
                console.warn(
                  "JSON íŒŒì‹± ì˜¤ë¥˜: ë¶ˆì™„ì „í•œ data ë¼ì¸. ë‹¤ìŒ ì²­í¬ì™€ ì¬ì‹œë„.",
                  e,
                  eventString
                );
                // ì˜¤ë¥˜ê°€ ë°œìƒí•œ ë¶€ë¶„ì€ ë‹¤ì‹œ ë²„í¼ì— ì¶”ê°€í•˜ì—¬ ë‹¤ìŒ ì²­í¬ì™€ í•©ì³ì§ˆ ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.
                buffer = eventString + SSE_DELIMITER + buffer;
                break; // í˜„ì¬ ë©”ì‹œì§€ ì²˜ë¦¬ë¥¼ ì¤‘ë‹¨í•˜ê³  ë‹¤ìŒ read()ë¥¼ ê¸°ë‹¤ë¦¼
              }
            } else if (eventString.startsWith("event: end")) {
              break;
            }
            delimiterIndex = buffer.indexOf(SSE_DELIMITER);
          }
        }
      } catch (error) {
        console.error("ì±—ë´‡ ìŠ¤íŠ¸ë¦¬ë° API í˜¸ì¶œ ì˜¤ë¥˜:", error);
        displayMessage(
          "ì£„ì†¡í•©ë‹ˆë‹¤. ì±—ë´‡ ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.",
          "bot"
        );
      } finally {
        // ìŠ¤íŠ¸ë¦¬ë°ì´ ì™„ë£Œë˜ê±°ë‚˜ ì˜¤ë¥˜ ë°œìƒ ì‹œ ìŠ¤í”¼ë„ˆ ì œê±° (ì´ë¯¸ textContentë¡œ ë®ì–´ì“°ì—¬ì ¸ ìˆê² ì§€ë§Œ ì•ˆì „ ì¥ì¹˜)
        if (
          currentBotMessageDiv &&
          currentBotMessageDiv.querySelector(".spinner-border")
        ) {
          currentBotMessageDiv.querySelector(".spinner-border").remove();
        }
      }
    }

    // ë©”ì‹œì§€ ì „ì†¡ ë¡œì§
    function sendMessage() {
      const messageText = chatInput.value.trim();
      if (messageText && selectedService) {
        displayMessage(messageText, "user");
        chatInput.value = "";

        // ìŠ¤íŠ¸ë¦¬ë° API í˜¸ì¶œ
        fetchChatResponseStream(messageText, selectedService);
      } else if (!selectedService) {
        displayMessage("ë¨¼ì € ì„œë¹„ìŠ¤ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.", "bot");
      }
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • (ê¸°ì¡´ê³¼ ë™ì¼)
    toggleBtn.addEventListener("click", function () {
      chatbotContainer.classList.toggle("active");
      if (chatbotContainer.classList.contains("active")) {
        initializeChatbot();
      }
    });

    closeBtn.addEventListener("click", function () {
      chatbotContainer.classList.remove("active");
      // initializeChatbot(); // ë‹«ì„ ë•Œ ì´ˆê¸°í™”ëŠ” toggleBtn í´ë¦­ ì‹œ ì²˜ë¦¬
    });

    sendMessageBtn.addEventListener("click", sendMessage);
    chatInput.addEventListener("keypress", function (event) {
      if (event.key === "Enter") {
        sendMessage();
      }
    });

    initializeChatbot();
  });
</script>
